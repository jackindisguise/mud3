<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta
			http-equiv="Content-Security-Policy"
			content="
				default-src 'self';
				script-src 'self';
				style-src 'self' 'unsafe-inline';
				img-src 'self' data:;
				font-src 'self' data:;
				connect-src 'self';
				media-src 'none';
				object-src 'none';
				base-uri 'self';
				form-action 'self';
				upgrade-insecure-requests;
			"
		/>
		<title>Dungeon Map Editor</title>
		<link rel="stylesheet" href="./static/dark.css" id="theme-stylesheet" />
		<link rel="stylesheet" href="./static/grid.css" />
		<script src="./static/theme-init.js"></script>
		<style>
			body {
				background: radial-gradient(
					circle at top,
					var(--base02),
					var(--base03) 60%
				);
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				height: 100vh;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}
			#app {
				flex: 1;
				display: flex;
				flex-direction: column;
				box-sizing: border-box;
			}
			header {
				margin: 0;
				border-radius: 0;
			}
			.main-container,
			.sidebar,
			main {
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<header>
				<div class="header-title">
					<h1>Dungeon Map Editor</h1>
					<div class="current-dungeon-display">
						<span id="current-dungeon-name">No dungeon selected</span>
						<button
							id="edit-dungeon-settings-btn"
							class="edit-dungeon-btn"
							title="Edit dungeon settings"
							disabled
						>
							‚öôÔ∏è Edit Settings
						</button>
					</div>
				</div>
				<div class="header-controls">
					<div class="dungeon-select-group">
						<select id="dungeon-select">
							<option value="">Select a dungeon...</option>
						</select>
					</div>
					<button id="save-btn">Save</button>
					<button
						id="theme-toggle-btn"
						class="theme-toggle-btn"
						title="Toggle light/dark mode"
					>
						üåô
					</button>
					<button id="help-btn" class="help-btn" title="Show help">?</button>
				</div>
			</header>

			<div class="main-container">
				<!-- Left Sidebar: Templates -->
				<aside class="sidebar left">
					<div class="tabs">
						<button class="tab active" data-tab="rooms">Rooms</button>
						<button class="tab" data-tab="mobs">Mobs</button>
						<button class="tab" data-tab="objects">Objects</button>
					</div>

					<!-- Room Templates -->
					<div class="tab-content active" id="rooms-tab">
						<div class="template-list" id="room-templates"></div>
						<button class="add-btn" id="add-room-btn">
							+ Add Room Template
						</button>
					</div>

					<!-- Mob Templates -->
					<div class="tab-content" id="mobs-tab">
						<div class="template-list" id="mob-templates"></div>
						<button class="add-btn" id="add-mob-btn">+ Add Mob Template</button>
					</div>

					<!-- Object Templates -->
					<div class="tab-content" id="objects-tab">
						<div class="template-list" id="object-templates"></div>
						<button class="add-btn" id="add-object-btn">
							+ Add Object Template
						</button>
					</div>
				</aside>

				<!-- Center: Map Grid -->
				<main class="map-container">
					<div class="map-area">
						<!-- Selection Tools Bar -->
						<div class="toolbox-bar">
							<div class="layer-controls">
								<label for="layer-select">Layer</label>
								<select id="layer-select"></select>
							</div>
							<div class="toolbox-label">Selection Tools</div>
							<div class="toolbox-tools">
								<button
									class="tool-btn"
									id="tool-line"
									data-tool="line"
									title="Line Selection"
								>
									‚ï±
								</button>
								<button
									class="tool-btn"
									id="tool-rectangle"
									data-tool="rectangle"
									title="Rectangle Selection"
								>
									‚ñ≠
								</button>
								<button
									class="tool-btn"
									id="tool-circle"
									data-tool="circle"
									title="Circle Selection"
								>
									‚óã
								</button>
								<button
									class="tool-btn"
									id="tool-squircle"
									data-tool="squircle"
									title="Squircle Selection"
								>
									‚ñ¢
								</button>
								<div class="edge-selection-group">
									<div class="edge-selection-label">Edge-only</div>
									<div class="edge-selection-buttons">
										<button
											class="tool-btn"
											id="tool-edge-line"
											data-tool="edge-line"
											title="Line Edge Selection"
										>
											‚ï±
										</button>
										<button
											class="tool-btn"
											id="tool-edge-rectangle"
											data-tool="edge-rectangle"
											title="Rectangle Edge Selection"
										>
											‚ñ≠
										</button>
										<button
											class="tool-btn"
											id="tool-edge-circle"
											data-tool="edge-circle"
											title="Circle Edge Selection"
										>
											‚óã
										</button>
										<button
											class="tool-btn"
											id="tool-edge-squircle"
											data-tool="edge-squircle"
											title="Squircle Edge Selection"
										>
											‚ñ¢
										</button>
									</div>
								</div>
							</div>
							<div class="toolbox-label" style="margin-left: 1rem">Actions</div>
							<div class="toolbox-tools">
								<button
									id="clear-resets-btn"
									class="action-btn"
									title="Clear resets in selection"
									disabled
								>
									Clear Resets
								</button>
								<button
									id="clear-exit-overrides-btn"
									class="action-btn"
									title="Clear exit overrides in selection"
									disabled
								>
									Clear Exit Overrides
								</button>
							</div>
						</div>
						<div class="map-grid" id="map-grid"></div>
						<!-- Toast Container -->
						<div id="toast-container" class="toast-container"></div>
						<!-- Placement Indicator -->
						<div
							id="placement-indicator"
							class="placement-indicator"
							style="display: none"
						>
							<div class="placement-indicator-content">
								<div class="placement-main-row">
									<div class="placement-icon"></div>
									<div class="placement-text">
										<div class="placement-action"></div>
										<div class="placement-template"></div>
									</div>
									<button
										class="placement-cancel"
										id="placement-cancel-btn"
										title="Cancel placement"
									>
										√ó
									</button>
								</div>
								<div class="placement-modes">
									<button
										class="placement-mode-btn"
										id="placement-mode-insert"
										data-mode="insert"
										title="Insert mode (click to place, drag to draw)"
									>
										‚úèÔ∏è
									</button>
									<button
										class="placement-mode-btn"
										id="placement-mode-paint"
										data-mode="paint"
										title="Paint mode (click to replace all identical templates)"
									>
										ü™£
									</button>
								</div>
							</div>
						</div>
					</div>
				</main>

				<!-- Right Sidebar: Resets & Info -->
				<aside class="sidebar right">
					<div class="tabs">
						<button class="tab active" data-tab="resets">Resets</button>
						<button class="tab" data-tab="info">Info</button>
						<button class="tab" data-tab="history">History</button>
					</div>

					<!-- Resets -->
					<div class="tab-content active" id="resets-tab">
						<div class="reset-list" id="reset-list"></div>
					</div>

					<!-- Info -->
					<div class="tab-content" id="info-tab">
						<div class="info-panel" id="info-panel">
							<p>
								Click on a room in the map to see its details and manage resets.
							</p>
						</div>
					</div>

					<!-- History -->
					<div class="tab-content" id="history-tab">
						<div class="history-panel">
							<div class="history-empty" id="history-empty">
								Make a change to start building history.
							</div>
							<div class="history-list" id="history-list"></div>
						</div>
					</div>
				</aside>
			</div>

			<!-- Modal for template editing -->
			<div id="template-modal" class="modal">
				<div class="modal-content">
					<span class="close">&times;</span>
					<h2 id="modal-title">Edit Template</h2>
					<div id="modal-body"></div>
					<div class="modal-actions">
						<button id="modal-save">Save</button>
						<button id="modal-cancel">Cancel</button>
					</div>
				</div>
			</div>

			<!-- Confirmation modal for dimension reduction -->
			<div id="confirm-modal" class="modal">
				<div class="modal-content">
					<h2>Confirm Dimension Reduction</h2>
					<p>
						Reducing dungeon dimensions will delete rooms and resets outside the
						new boundaries. This cannot be undone.
					</p>
					<div class="modal-actions">
						<button id="confirm-yes">Yes, Continue</button>
						<button id="confirm-no">Cancel</button>
					</div>
				</div>
			</div>

			<!-- Status Bar -->
			<div id="status-bar" class="status-bar">
				<div class="status-section status-template">
					<span class="status-label">Template:</span>
					<span class="status-value" id="status-template">None</span>
				</div>
				<div class="status-section status-tool">
					<span class="status-label">Tool:</span>
					<span class="status-value" id="status-tool">None</span>
				</div>
				<div class="status-section status-mode">
					<span class="status-label">Mode:</span>
					<span class="status-value" id="status-mode">Insert</span>
				</div>
				<div class="status-section status-position">
					<span class="status-label">Position:</span>
					<span class="status-value" id="status-position">‚Äî</span>
				</div>
				<div class="status-section status-history">
					<span class="status-label">History:</span>
					<span class="status-value" id="status-history">0</span>
				</div>
				<div class="status-section status-changes">
					<span class="status-label">Changes:</span>
					<span class="status-value" id="status-changes">Saved</span>
				</div>
			</div>

			<!-- New Dungeon Modal -->
			<div id="new-dungeon-modal" class="modal">
				<div class="modal-content">
					<span class="close" id="new-dungeon-close">&times;</span>
					<h2>Create New Dungeon</h2>
					<div class="form-group">
						<label>Dungeon Name:</label>
						<input
							type="text"
							id="new-dungeon-name"
							placeholder="my-dungeon"
							pattern="[a-z0-9_-]+"
							title="Only lowercase letters, numbers, hyphens, and underscores allowed"
						/>
						<small
							style="
								color: #aaa;
								font-size: 0.85rem;
								display: block;
								margin-top: 0.25rem;
							"
						>
							Lowercase letters, numbers, hyphens, and underscores only
						</small>
					</div>
					<div class="form-group">
						<label>Width:</label>
						<input
							type="number"
							id="new-dungeon-width"
							min="1"
							max="100"
							value="10"
						/>
					</div>
					<div class="form-group">
						<label>Height:</label>
						<input
							type="number"
							id="new-dungeon-height"
							min="1"
							max="100"
							value="10"
						/>
					</div>
					<div class="form-group">
						<label>Layers:</label>
						<input
							type="number"
							id="new-dungeon-layers"
							min="1"
							max="100"
							value="1"
						/>
					</div>
					<div class="modal-actions">
						<button id="new-dungeon-create">Create</button>
						<button id="new-dungeon-cancel">Cancel</button>
					</div>
				</div>
			</div>

			<!-- Help modal -->
			<div id="help-modal" class="modal">
				<div class="modal-content help-modal-content">
					<span class="close" id="help-close">&times;</span>
					<h2>Help & Tips</h2>
					<div class="help-content">
						<section class="help-section">
							<h3>Keyboard Shortcuts</h3>
							<ul>
								<li>
									<strong>Ctrl+C</strong> - Copy selected cells to clipboard
								</li>
								<li>
									<strong>Ctrl+X</strong> - Cut selected cells (copy and delete)
								</li>
								<li>
									<strong>Ctrl+V</strong> - Paste clipboard at current mouse
									position
								</li>
								<li>
									<strong>Ctrl+A</strong> - Select all cells on current layer
								</li>
								<li><strong>Ctrl+Z</strong> - Undo last action</li>
								<li>
									<strong>Ctrl+Y</strong> or <strong>Ctrl+Shift+Z</strong> -
									Redo last undone action
								</li>
								<li><strong>Delete</strong> - Delete selected rooms</li>
								<li>
									<strong>Escape</strong> - Close modals, cancel selection, or
									clear selection tool
								</li>
								<li><strong>Page Up</strong> - Go to next layer (higher)</li>
								<li>
									<strong>Page Down</strong> - Go to previous layer (lower)
								</li>
								<li><strong>Home</strong> - Jump to first layer (layer 0)</li>
								<li><strong>End</strong> - Jump to last layer</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Templates & Placement Modes</h3>
							<ul>
								<li>
									Select a template from the left sidebar (Rooms, Mobs, or
									Objects)
								</li>
								<li>
									In <strong>Insert Mode</strong> (‚úèÔ∏è): Click and drag to paint
									templates continuously across cells
								</li>
								<li>
									In <strong>Paint Mode</strong> (ü™£): Click to flood-fill all
									connected cells with matching templates
								</li>
								<li>
									Toggle between Insert and Paint modes using the buttons in the
									placement indicator (bottom right)
								</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Selection Tools</h3>
							<ul>
								<li>
									Click any selection tool in the Selection Tools bar (below the
									dungeon options) to activate it
								</li>
								<li>
									<strong>Line</strong> (‚ï±) - Draw a straight selection between
									two points on the same layer
								</li>
								<li>
									<strong>Rectangle</strong> (‚ñ≠) - Select all cells in a
									rectangular area
								</li>
								<li>
									<strong>Circle</strong> (‚óã) - Select all cells within a
									circular area
								</li>
								<li>
									<strong>Squircle</strong> (‚ñ¢) - Select all cells within a
									rounded rectangle
								</li>
								<li>
									<strong>Edge tools</strong> (‚ï≤, ‚ñ≠, ‚óã, ‚ñ¢) - Use the Edge-only
									group to select just the outlines of lines, rectangles,
									circles, or squircles
								</li>
								<li>
									Hold <strong>Ctrl</strong> (or <strong>‚åò</strong> on macOS)
									while dragging to add to the existing selection instead of
									replacing it
								</li>
								<li>
									Click and drag on the map to create or adjust a selection
								</li>
								<li>
									Click the same tool again (or press Esc) to deselect it and
									clear the highlighted cells
								</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Copy, Cut & Paste</h3>
							<ul>
								<li>
									Select cells using any selection tool, then use
									<strong>Ctrl+C</strong> to copy or <strong>Ctrl+X</strong> to
									cut them
								</li>
								<li>
									Copied or cut cells include both rooms and their resets
									(mobs/objects)
								</li>
								<li>
									Use <strong>Ctrl+V</strong> to paste at the currently selected
									cell position, or at (0, 0) on the current layer if no cell is
									selected
								</li>
								<li>
									Cut operations copy the cells and then delete them from the
									grid, making it easy to move rooms to new locations
								</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Auto-Fill Selection</h3>
							<ul>
								<li>First, use a selection tool to select cells on the map</li>
								<li>
									Then click any template (Room, Mob, or Object) to
									automatically fill all selected cells with that template
								</li>
								<li>
									The selection clears after filling, but your selection tool
									stays active so you can reuse it immediately
								</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Template & Reset Actions</h3>
							<ul>
								<li>
									Use the <strong>‚úèÔ∏è</strong> button below any template to open
									it for editing, or <strong>üóëÔ∏è</strong> to remove it
								</li>
								<li>
									Reset entries show their details first, with the same action
									buttons beneath‚Äîedit to tweak counts/equipment, delete to
									remove the reset
								</li>
								<li>
									These buttons also appear in the template selection modals, so
									you can manage content without leaving the editor
								</li>
								<li>
									When editing resets, use the <strong>Minimum</strong> and
									<strong>Maximum</strong> count fields to set the spawn range
									for mobs and objects
								</li>
								<li>
									Use the <strong>Add/Edit Exit Override</strong> button in room
									info to customize which directions are allowed for specific
									rooms. Exit buttons are organized in rows: cardinals (north,
									south, east, west) on the first row, diagonals (northeast,
									northwest, southeast, southwest) on the second row, and
									vertical (up, down) on the third row
								</li>
								<li>
									In the exit override editor, click the small
									<strong>‚¶ø</strong> button at the start of each row to toggle
									all exits in that row on or off at once
								</li>
							</ul>
						</section>

						<section class="help-section">
							<h3>Theme & Appearance</h3>
							<ul>
								<li>
									Click the <strong>üåô/‚òÄÔ∏è</strong> button in the header to
									toggle between dark and light themes
								</li>
								<li>
									Your theme preference is automatically saved and will persist
									across sessions
								</li>
							</ul>
						</section>
					</div>
					<div class="modal-actions">
						<button id="help-close-btn">Close</button>
					</div>
				</div>
			</div>

			<!-- Modal for editing resets -->
			<div id="reset-edit-modal" class="modal">
				<div class="modal-content">
					<span class="close" id="reset-edit-close">&times;</span>
					<h2>Edit Reset</h2>
					<div
						class="form-group"
						id="reset-info-display"
						style="
							margin-bottom: 1.5rem;
							padding: 1rem;
							background: #2a2a2a;
							border-radius: 4px;
							border: 1px solid #555;
						"
					>
						<div style="color: #ccc; font-size: 0.9rem; margin-bottom: 0.5rem">
							<strong>Template:</strong> <span id="reset-template-name"></span>
						</div>
						<div style="color: #ccc; font-size: 0.9rem">
							<strong>Location:</strong> <span id="reset-location"></span>
						</div>
					</div>
					<div class="form-group">
						<div
							style="display: flex; gap: 1rem; align-items: center; width: 100%"
						>
							<div
								style="display: flex; align-items: center; gap: 0.5rem; flex: 1"
							>
								<label>Minimum:</label>
								<input
									type="number"
									id="reset-min-count"
									min="1"
									value="1"
									style="width: 100%"
								/>
							</div>
							<div
								style="display: flex; align-items: center; gap: 0.5rem; flex: 1"
							>
								<label>Maximum:</label>
								<input
									type="number"
									id="reset-max-count"
									min="1"
									value="1"
									style="width: 100%"
								/>
							</div>
						</div>
					</div>
					<!-- New Mob-specific fields (initially hidden) -->
					<div id="reset-mob-fields" style="display: none">
						<div class="form-group">
							<label>Equipped Templates:</label>
							<div class="template-selection-container">
								<div class="template-table-container">
									<div class="template-table-header">Available Equipment</div>
									<div
										class="template-table"
										id="equipped-templates-table"
									></div>
								</div>
								<div class="template-list-container">
									<div class="template-list-header">Selected Equipment</div>
									<div class="template-list" id="equipped-list"></div>
								</div>
							</div>
							<input type="hidden" id="reset-equipped" />
						</div>
						<div class="form-group">
							<label>Inventory Templates:</label>
							<div class="template-selection-container">
								<div class="template-table-container">
									<div class="template-table-header">Available Items</div>
									<div
										class="template-table"
										id="inventory-templates-table"
									></div>
								</div>
								<div class="template-list-container">
									<div class="template-list-header">Selected Items</div>
									<div class="template-list" id="inventory-list"></div>
								</div>
							</div>
							<input type="hidden" id="reset-inventory" />
						</div>
					</div>
					<div class="modal-actions">
						<button id="reset-edit-save">Save</button>
						<button id="reset-edit-cancel">Cancel</button>
					</div>
				</div>
			</div>

			<!-- Dungeon settings modal -->
			<div id="dungeon-settings-modal" class="modal">
				<div class="modal-content dungeon-settings-content">
					<span class="close" id="dungeon-settings-close">&times;</span>
					<h2>Dungeon Settings</h2>
					<div class="dungeon-settings-grid">
						<div class="form-group">
							<label>Dungeon Name</label>
							<input
								type="text"
								id="dungeon-name-input"
								placeholder="Display name..."
							/>
						</div>
						<div class="form-group">
							<label>Dungeon Description</label>
							<textarea
								id="dungeon-description-input"
								rows="3"
								placeholder="Short description..."
							></textarea>
						</div>
						<div class="form-group">
							<label>Dimensions</label>
							<div class="dimension-inputs">
								<input
									type="number"
									id="width-input"
									min="1"
									max="100"
									placeholder="Width"
								/>
								<input
									type="number"
									id="height-input"
									min="1"
									max="100"
									placeholder="Height"
								/>
								<input
									type="number"
									id="layers-input"
									min="1"
									max="100"
									placeholder="Layers"
								/>
							</div>
						</div>
						<div class="form-group">
							<label>Reset Message</label>
							<input
								type="text"
								id="reset-message-input"
								placeholder="Reset message..."
							/>
						</div>
					</div>
					<div class="modal-actions dungeon-settings-actions">
						<button id="apply-dungeon-settings-btn">Apply Dimensions</button>
						<button id="mobius-perimeter-btn">Apply Mobius Perimeter</button>
						<button id="dungeon-settings-done">Done</button>
					</div>
				</div>
			</div>
		</div>

		<script src="./static/vendor/js-yaml.min.js"></script>
		<script type="module" src="./static/app.js"></script>
	</body>
</html>
